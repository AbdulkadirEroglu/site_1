{% extends "admin/base.html" %}

{% block head_extras %}
<link rel="stylesheet" href="{{ url_for('static', path='vendor/ckeditor/ckeditor/ckeditor5.css') }}?v={{ static_version }}" />
{% endblock %}

{% block layout %}
<div class="admin-shell">
    {% include "admin/partials/sidebar.html" %}
    <main class="admin-content">
        <header class="admin-header">
            <h1>{{ form_title }}</h1>
            <a class="btn ghost" href="/admin/products">Back to list</a>
        </header>
        <section class="panel">
            <header>
                <div>
                    <h2>Product details</h2>
                    <p class="panel-subtitle">Provide the required identifiers and optional metadata.</p>
                </div>
            </header>
            <form class="admin-form" method="post" action="{{ form_action }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                {% if form_error %}
                <div class="form-error" role="alert">{{ form_error }}</div>
                {% endif %}
                <div class="grid-2">
                    <label>
                        Name
                        <input name="name" type="text" required value="{{ form_data.name }}" />
                    </label>
                    <label>
                        SKU
                        <input name="sku" type="text" required value="{{ form_data.sku }}" />
                    </label>
                </div>
                <div class="grid-2">
                    <label>
                        OEM number
                        <input name="oem_number" type="text" required value="{{ form_data.oem_number }}" />
                    </label>
                    <label>
                        Category
                        <select name="category_id">
                            <option value="">Unassigned</option>
                            {% for category in categories %}
                            <option value="{{ category.id_str }}" {% if form_data.category_id == category.id_str %}selected{% endif %}>{{ category.label }}</option>
                            {% endfor %}
                        </select>
                    </label>
                </div>
                <div class="toggle-field">
                    <span class="toggle-title">Status</span>
                    <label class="toggle-pill">
                        <input type="checkbox" name="is_active" value="true" {% if form_data.is_active %}checked{% endif %} />
                        <span class="toggle-track">
                            <span class="toggle-option toggle-option-on">Active</span>
                            <span class="toggle-option toggle-option-off">Inactive</span>
                        </span>
                    </label>
                    <p class="field-note">Active products appear in the public catalog.</p>
                </div>
                <label class="rich-field">
                    <span class="field-label">Summary</span>
                    <div class="form-warning editor-warning" data-ckeditor-warning role="alert">
                        CKEditor failed to load. Confirm <code>ckeditor.js</code> and <code>ckeditor/ckeditor5.umd.js</code> exist in <code>app/static/vendor/ckeditor/</code> and refresh.
                    </div>
                    <textarea id="editor" name="summary" class="editor-field" data-ckeditor data-ckeditor-external rows="10">{{ form_data.summary|richtext|forceescape }}</textarea>
                    <p class="field-note">Format descriptions with fonts, sizes, links, and colors.</p>
                </label>
                <section class="image-manager">
                    <header>
                        <h3>Images</h3>
                        <p class="panel-subtitle">Upload, reorder, or remove gallery images.</p>
                    </header>
                    {% if existing_images %}
                    <ul class="image-list">
                        {% for image in existing_images %}
                        <li class="image-card">
                            <div class="image-card-header">
                                <img src="{{ image.url }}" alt="{{ image.alt_text or form_data.name or 'Product image' }}" loading="lazy" />
                            </div>
                            <div class="image-card-body">
                                <label>
                                    Alt text
                                    <input type="text" name="existing_image_alt_{{ image.id }}" value="{{ image.alt_text }}" />
                                </label>
                                <div class="image-field-row">
                                    <label>
                                        Display order
                                        <input type="number" name="existing_image_order_{{ image.id }}" value="{{ image.sort_order }}" />
                                    </label>
                                    <div class="image-delete">
                                        <input class="sr-only image-delete-checkbox" type="checkbox" id="delete-image-{{ image.id }}" name="existing_image_delete_{{ image.id }}" {% if image.pending_delete %}checked{% endif %} />
                                        <button class="btn danger image-delete-btn" type="button" data-image-delete-button data-target="delete-image-{{ image.id }}">Remove image</button>
                                        <span class="image-delete-note" aria-live="polite">Marked for removal</span>
                                    </div>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="field-note">No images yet. Upload files below to populate the gallery.</p>
                    {% endif %}
                    <label>
                        Upload new images
                        <input type="file" name="new_images" accept="image/*" multiple />
                    </label>
                    <p class="field-note">New uploads are added after you save. Set final order/alt text by editing the product again if needed.</p>
                </section>
                <div class="form-actions">
                    <button class="btn ghost" type="reset">Reset</button>
                    <button class="btn primary" type="submit">{{ submit_label }}</button>
                </div>
            </form>
        </section>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='vendor/ckeditor/ckeditor/ckeditor5.umd.js') }}?v={{ static_version }}" defer></script>
<script src="{{ url_for('static', path='vendor/ckeditor/ckeditor.js') }}?v={{ static_version }}" defer></script>
{% endblock %}
